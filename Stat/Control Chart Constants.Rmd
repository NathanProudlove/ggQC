---
title: "Calculating Control Chart Constants"
output: html_notebook
---

```{r}


Make_Qualitity_Control_Constants <- function(n){
  FUN_List <- list(RANGE_x = function(X){max(X)-min(X)}, SD_x=sd, MEAN_x=mean, MEDIAN_x=median)
  FUN_List_Outter <- list(mean=mean, median=median, sd=sd)
  
  n <- n
  runs <- ((1e6 * sqrt(n)) %/% n)*n
  
  BaseConstants <- apply(X = apply(
                X = matrix(rnorm(runs), ncol = n),
                MARGIN = 1,
                FUN = function(X) {unlist(lapply(FUN_List, FUN = function(f){f(X)}))}),
        MARGIN = 1, 
        FUN = function(Z) {unlist(lapply(FUN_List_Outter, FUN = function(f){f(Z)}))}
        )
      
  #BaseConstants
  
  
constants <- round(data.frame(n = n,
       ####R-bar Mean(mean(X))
       d2 = BaseConstants["mean","RANGE_x"], #Root X-bar
       E2 = 3/BaseConstants["mean","RANGE_x"], #3 Sigma non stdentized
       A2 = 3/(BaseConstants["mean","RANGE_x"]*sqrt(n)), #3 sigma Sutdentized
       d3 = BaseConstants["sd","RANGE_x"], #Root for R-bar
       D3 = ifelse(1 - (3*BaseConstants["sd","RANGE_x"]/BaseConstants["mean","RANGE_x"]) < 0 , # Minus 3 Sigma for Range X 
                   0 , 
                   1 - (3*BaseConstants["sd","RANGE_x"]/BaseConstants["mean","RANGE_x"])
                   ), 
       D4 = 1 + (3*BaseConstants["sd","RANGE_x"]/BaseConstants["mean","RANGE_x"]), # Plus 3 Sigma for Range X
       
       
       
       #s-bar mean(mean(x))
       c4 = BaseConstants["mean","SD_x"],
       A3 = 3/(BaseConstants["mean","SD_x"]*sqrt(n)),
       B3 = ifelse(1 - 3/BaseConstants["mean","SD_x"]*sqrt(1-BaseConstants["mean","SD_x"]^2) < 0, # Minus 3 Sigma for Range X 
                   0, 
                   1 - 3/BaseConstants["mean","SD_x"]*sqrt(1-BaseConstants["mean","SD_x"]^2)
                   ),
       B4 = 1 + 3/BaseConstants["mean","SD_x"]*sqrt(1-BaseConstants["mean","SD_x"]^2),
       
       ###Median R Mean(mean(X))
       d4 = BaseConstants["median","RANGE_x"],
       A4 = 3/(BaseConstants["median","RANGE_x"]*sqrt(n)),
       D5 = ifelse(1 - (3.07*BaseConstants["sd","RANGE_x"]/BaseConstants["median","RANGE_x"]) < 0 , # Minus 3 Sigma for Range X 
                   0 , 
                   1 - (3.07*BaseConstants["sd","RANGE_x"]/BaseConstants["median","RANGE_x"])
                   ), 
       D6 = 1 + (3.07*BaseConstants["sd","RANGE_x"]/BaseConstants["median","RANGE_x"]), # Plus 3 Sigma for Range X
       
       ###R-Bar Mean(Median(X))
       A6 = 3/(BaseConstants["mean","RANGE_x"]*sqrt(n))*BaseConstants["sd","MEDIAN_x"]/BaseConstants["sd","MEAN_x"],
       
       ####Median R Mean(Median(X))
       A9 = 3/(BaseConstants["median","RANGE_x"]*sqrt(n))*BaseConstants["sd","MEDIAN_x"]/BaseConstants["sd","MEAN_x"]
  ), digits = 3)

return(constants)

}


  ###C4 mean(apply(X = matrix(rnorm(runs), ncol = n), MARGIN = 1, FUN = sd))


```
```{r}
Ns_in_table <-  2:20
require(snow)
clus <- makeCluster(3)
set.seed(5555)
system.time(test <- parLapply(clus, Ns_in_table, Make_Qualitity_Control_Constants)) #139 seconds for 10; 
Constants_Table <- do.call(rbind, test)
write.table(Constants_Table, file = "../R/Constants_Table.csv", quote = F, sep = ",", row.names = F)

```

```{r, eval=FALSE, include=FALSE}


n <- 2
d2 <- function(n){

runs <- 1e6 * sqrt(n)
system.time({
mean(apply(
          X = matrix(rnorm(runs), ncol = n),
          MARGIN = 1,
          FUN = function(X) {
          sd(X)
          }
          ))

mean(apply(
          X = matrix(rnorm(runs), ncol = n),
          MARGIN = 1,
          FUN = function(X) {
          max(X) - min(X)
          }
          ))
})

  ###C4 mean(apply(X = matrix(rnorm(runs), ncol = n), MARGIN = 1, FUN = sd))
}

d2_k <- sapply(2:16, d2)

d2_k

#Mean(R) = d2_k * S
#s = Mean(R)/d2_k
#Three Sigma
#3S = Mean(R)* 3 / d2_K
3/d2_k
3/(d2_k*sqrt(2:16))

require(magrittr)
replicate(100000, rnorm(n=2) %>% 
             range() %>%
             diff() %>%
             abs() 
) %>% mean()

d2 <- mean(replicate(1000000, abs(diff(range(rnorm(2))))))
d2  
  


replic
1/sqrt(2)*
  mean(apply(X = matrix(rt(runs, df = 2), ncol = n), MARGIN = 1, FUN = function(X){max(X)-min(X)}))
```

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).
